---
title: "Bomen delineatie"
output: html_notebook
---
```{r}
library(terra) # For raster processing

# Define file paths
input_dir <- "E:/Thesis Thomas/DHT/DEM update/"
output_dir <- "../output"

# Ensure output directories exist
if (!dir.exists(output_dir)) {
  dir.create(output_dir, recursive = TRUE)
}
if (!dir.exists(file.path(output_dir, "DTM"))) {
  dir.create(file.path(output_dir, "DTM"), recursive = TRUE)
}
if (!dir.exists(file.path(output_dir, "DSM"))) {
  dir.create(file.path(output_dir, "DSM"), recursive = TRUE)
}
if (!dir.exists(file.path(output_dir, "CHM"))) {
  dir.create(file.path(output_dir, "CHM"), recursive = TRUE)
}
if (!dir.exists(file.path(output_dir, "tree_tops"))) {
  dir.create(file.path(output_dir, "tree_tops"), recursive = TRUE)
}
if (!dir.exists(file.path(output_dir, "tree_crowns"))) {
  dir.create(file.path(output_dir, "tree_crowns"), recursive = TRUE)
}


# Path to DTM
dtm_path <- "Z:/Vlaanderen/Hoogte/DHMVII/DHMVIIDTMRAS1m.tif"
dtm <- rast(dtm_path)

#List all drone raster files in the input directory
drone_files <- list.files(input_dir, pattern = "\\.tif$", full.names = TRUE)

```

```{r}
# Process each drone raster
for (drone_file in drone_files) {
  cat("Processing:", drone_file, "\n")
  
  tryCatch({
    # Load the DSM raster
    dsm_drone <- rast(drone_file)
    
    # Reproject DSM to match DTM CRS
    dsm_reprojected <- project(dsm_drone, crs(dtm), method = "cubic")
    
    # Save the reprojected DSM
    dsm_output_path <- file.path(output_dir, "DSM", paste0("dsm_", basename(drone_file)))
    writeRaster(dsm_reprojected, dsm_output_path, overwrite = TRUE)
    
    # Clip and resample DTM
    dtm_clipped <- crop(dtm, dsm_reprojected)
    dtm_resampled <- resample(dtm_clipped, dsm_reprojected, method = "cubic")
    
    # Save the processed DTM
    dtm_output_path <- file.path(output_dir, "DTM", paste0("dtm_", basename(drone_file)))
    writeRaster(dtm_resampled, dtm_output_path, overwrite = TRUE)
    
    # Calculate CHM
    chm <- dsm_reprojected - dtm_resampled
    
    # Rescale CHM
    p1 <- quantile(values(chm), probs = 0.01, na.rm = TRUE)
    chm_rescaled <- chm - p1
    chm_rescaled[chm_rescaled < 0] <- 0
    
    # Save the rescaled CHM
    chm_output_path <- file.path(output_dir, "CHM", paste0("chm_rescaled_", basename(drone_file)))
    writeRaster(chm_rescaled, chm_output_path, overwrite = TRUE)
    
    # Detect tree tops
    chm_raster <- raster(chm_rescaled)
    tree_tops <- vwf(CHM = chm_raster, winFun = function(x) 0 * x + 3.17, minHeight = 4)
    
    # Save tree tops as shapefile
    ttops_sf <- st_as_sf(tree_tops)
    ttops_output_path <- file.path(output_dir, "tree_tops", paste0("tree_tops_", tools::file_path_sans_ext(basename(drone_file)), ".shp"))
    st_write(ttops_sf, ttops_output_path, delete_layer = TRUE)
    
    # Apply MCWS for tree crowns
    tree_crowns <- mcws(treetops = tree_tops, CHM = chm_raster, minHeight = 4)
    tree_crowns_poly <- as.polygons(tree_crowns)
    tree_crowns_sf <- st_as_sf(tree_crowns_poly)
    
    # Save tree crowns as shapefile
    tree_crowns_output_path <- file.path(output_dir, "tree_crowns", paste0("tree_crowns_", tools::file_path_sans_ext(basename(drone_file)), ".shp"))
    st_write(tree_crowns_sf, tree_crowns_output_path, delete_layer = TRUE)
    
    cat("Completed processing:", drone_file, "\n")
    
  }, error = function(e) {
    cat("Error processing file:", drone_file, "\n", e$message, "\n")
  })
}
```

